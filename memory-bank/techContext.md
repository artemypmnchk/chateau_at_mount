# Технический контекст: Chateau Bot

## Выбор технологий для Serverless

### Основной стек (Serverless)
- **Go 1.21+**: Основной язык для serverless функций
- **go-telegram-bot-api**: Библиотека для работы с Telegram Bot API
- **net/http**: Стандартная библиотека для HTTP handlers
- **Vercel Functions**: Serverless platform для развертывания

### Альтернативные облачные платформы
- **Railway.app**: Для долгоработающих Go приложений (если нужен long polling)
- **Render.com**: Бесплатный tier для небольших приложений
- **Fly.io**: Поддержка контейнеров и Go приложений
- **Supabase Edge Functions**: Альтернатива с Deno/TypeScript

### Дополнительные инструменты
- **os**: Работа с переменными окружения
- **encoding/json**: JSON обработка для webhook данных
- **log**: Логирование (Vercel автоматически собирает логи)
- **crypto/hmac**: Проверка подписи webhook (если поддерживается)

## Serverless архитектура

### Модульная структура для Vercel
```
chateau-bot/
├── api/
│   ├── webhook.go     # Vercel function для обработки webhook
│   └── telegram.go    # Функции для работы с Telegram API
├── pkg/
│   ├── telegram/      # Telegram client
│   ├── message/       # Обработка сообщений
│   └── config/        # Конфигурация
├── vercel.json        # Конфигурация Vercel
├── go.mod
├── go.sum
└── README.md
```

### Архитектурные изменения для Serverless

#### 1. Stateless функции
- Каждый webhook запрос обрабатывается отдельной функцией
- Нет постоянного состояния между запросами
- Конфигурация загружается из переменных окружения

#### 2. Webhook-only подход
- Только webhook режим (не long polling)
- Каждый webhook запрос = одна serverless функция
- Быстрая обработка и ответ (timeout ограничения)

#### 3. Внешнее хранение состояния
- Переменные окружения для конфигурации
- Возможно использование внешней БД для сложных настроек
- Redis/Upstash для кэширования (при необходимости)

## Преимущества Serverless для данного проекта

### Стоимость
- **Бесплатные лимиты**: Vercel предоставляет щедрые бесплатные лимиты
- **Pay-per-use**: Платишь только за использование
- **Нет постоянных серверов**: Никаких расходов на простой

### Масштабирование
- **Автоматическое масштабирование**: Vercel автоматически масштабирует под нагрузку
- **Глобальная CDN**: Быстрый ответ из ближайшего региона
- **Cold start optimization**: Go имеет быстрый cold start

### Простота развертывания
- **Git-based deployment**: Автодеплой при push в репозиторий
- **Zero configuration**: Минимальная настройка для простых случаев
- **Environment variables**: Простое управление секретами

## Ограничения Serverless

### Время выполнения
- **Vercel Hobby**: 10 секунд максимум
- **Vercel Pro**: 15 минут максимум
- **Решение**: Быстрая обработка webhook, async отправка если нужно

### Память
- **Vercel**: До 1GB RAM на функцию
- **Решение**: Эффективная обработка данных, стриминг больших файлов

### Конкурентность
- **Каждый запрос = новая функция**: Нет shared state
- **Решение**: Stateless design, внешнее хранение при необходимости

## Альтернативные платформы для сравнения

### Railway.app
```
+ Поддержка долгоработающих процессов
+ Простое развертывание с GitHub
+ Бесплатный tier с ограничениями
- Может засыпать при неактивности
```

### Render.com
```
+ Бесплатный tier для веб-сервисов
+ Поддержка Docker и нативных билдов
+ Automatic SSL
- Ограниченные ресурсы на бесплатном тире
```

### Fly.io
```
+ Отличная поддержка Go
+ Глобальная сеть
+ Generous free tier
- Более сложная настройка
```

## Рекомендуемая архитектура

### Для простых случаев: Vercel
- Webhook endpoint как Vercel function
- Переменные окружения для токенов
- Простая логика обработки

### Для сложных случаев: Railway/Render
- Полноценное Go приложение
- Long polling или webhook
- Возможность использования баз данных

## Развертывание на Vercel

### Конфигурация vercel.json
```json
{
  "functions": {
    "api/webhook.go": {
      "runtime": "@vercel/go"
    }
  },
  "env": {
    "TELEGRAM_TOKEN": "@telegram_token"
  }
}
```

### Environment Variables
- `TELEGRAM_TOKEN`: Токен бота
- `WEBHOOK_SECRET`: Секрет для проверки webhook (опционально)
- `ALLOWED_CHANNELS`: JSON массив разрешенных каналов

### Автоматическое развертывание
1. Подключение GitHub репозитория к Vercel
2. Настройка переменных окружения в Vercel dashboard
3. Автоматический деплой при push в main branch 